[build-system]
requires = ["setuptools", "Cython"]
build-backend = "setuptools.build_meta"

[tool.cibuildwheel]
test-command = "python {project}/test/noddi.py"
build-verbosity = 3

[tool.cibuildwheel.windows]
before-all = [
    "7z x test/demo.zip -otest/demo", # NOTE move in before-test?
    "7z x OpenBLAS-0.3.21-x64.zip -o\"OpenBLAS-0.3.21\""
]
before-build = "pip install delvewheel"
repair-wheel-command = "delvewheel repair --add-path OpenBLAS-0.3.21\\bin -w {dest_dir} {wheel}"
archs = ["AMD64"]

[tool.cibuildwheel.linux]
environment = {LD_LIBRARY_PATH="$(pwd)/OpenBLAS-0.3.21"}
before-all = [
    "unzip test/demo.zip -d test/demo", # NOTE move in before-test?
    "tar -xzf OpenBLAS-0.3.21.tar.gz",
    "make -C OpenBLAS-0.3.21 DYNAMIC_ARCH=1"
]
archs = ["x86_64"]

[tool.cibuildwheel.macos]
environment = {REPAIR_LIBRARY_PATH="$(pwd)/OpenBLAS-0.3.21", MACOSX_DEPLOYMENT_TARGET="11.0"}
before-all = [
    "tar -xzf OpenBLAS-0.3.21.tar.gz",
    "make -C OpenBLAS-0.3.21 DYNAMIC_ARCH=1"
]
repair-wheel-command = "DYLD_LIBRARY_PATH=$REPAIR_LIBRARY_PATH delocate-wheel --require-archs {delocate_archs} -w {dest_dir} -v {wheel}"
archs = ["arm64"]
